<!--
    This file makes several assumptions about internal implementation details of Shibboleth:

    java-identity-provider/idp-conf-impl/src/main/resources/net/shibboleth/idp/conf/webflow-config.xml
    contains these DefaultFlowMap entries (among others):
    - <entry key="saml.abstract" value="classpath:/net/shibboleth/idp/flows/saml/saml-abstract-flow.xml" />
    - <entry key="saml2.sso.abstract" value="classpath:/net/shibboleth/idp/flows/saml/saml2/sso-abstract-flow.xml" />
    - <entry key="SAML2/Redirect/SSO" value="classpath:/net/shibboleth/idp/flows/saml/saml2/sso-redirect-flow.xml" />

    java-identity-provider/idp-conf-impl/src/main/resources/net/shibboleth/idp/flows/saml/saml2/sso-redirect-flow.xml
    is a tiny file which contains only:
    - parent="saml2.sso.abstract"
    - <bean-import resource="sso-redirect-beans.xml" />

    java-identity-provider/idp-conf-impl/src/main/resources/net/shibboleth/idp/flows/saml/saml2/sso-abstract-flow.xml
    is a flow with parent="saml.abstract", and the first state has id="InitializeProfileRequestContext".

    java-identity-provider/idp-conf-impl/src/main/resources/net/shibboleth/idp/flows/saml/saml-abstract-flow.xml
    - has no parent attribute
    - contains <action-state id="DecodeMessage"> with a single <transition> going to="CheckInboundInterceptContext"
    - contains <decision-state id="CheckInboundInterceptContext">
-->

<!--
    This flow is a slightly custom version of "SAML2/Redirect/SSO".

    Differences:

    - It checks whether the front SP and back SP are allowed to connect. (The main reason for its existence.)
    - It checks that it is called from our HttpController, not directly by an external user.
    - It overrides the SAML Destination="" attribute check to look for the original flow URL.

    We can't simply inherit directly from parent="SAML2/Redirect/SSO" because it uses a relative path import of
    sso-redirect-beans.xml, which would be incorrectly looked up in this directory. See the note in
    <https://docs.spring.io/spring-webflow/docs/3.0.x/reference/#_flow_inheritance_algorithm>. Instead we inherit from
    its own parent ("saml2.sso.abstract"), and import sso-redirect-beans.xml with a full path.
-->

<flow xmlns="http://www.springframework.org/schema/webflow"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.springframework.org/schema/webflow http://www.springframework.org/schema/webflow/spring-webflow.xsd"
      parent="saml2.sso.abstract">

    <action-state id="AndrvotrStart">
        <evaluate expression="AndrvotrPrepareCustomFlow" />
        <evaluate expression="'proceed'" />

        <transition on="proceed" to="InitializeProfileRequestContext" />
        <transition on="error" to="AndrvotrStartError" />
    </action-state>

    <end-state id="AndrvotrStartError" />

    <decision-state id="CheckInboundInterceptContext">
        <on-entry>
            <evaluate expression="AndrvotrPostprocessDecodedMessage" />
        </on-entry>
    </decision-state>

    <bean-import resource="classpath:/net/shibboleth/idp/flows/saml/saml2/sso-redirect-beans.xml" />
    <bean-import resource="custom-beans.xml" />

</flow>
